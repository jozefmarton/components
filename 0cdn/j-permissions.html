<style>.ui-permissions-header{height:30px;cursor:pointer;color:#777;font-size:12px}.ui-permissions-header:hover{color:#000}.ui-permissions-header .green{float:right;width:30px;line-height:30px;text-align:right;transform:scale(1);font-size:14px}.ui-permissions-header span{margin:0 30px 0 0;display:block;line-height:30px}.ui-permissions-header span:after{content:':'}.ui-permissions table{width:100%;table-layout:fixed;font-size:13px}.ui-permissions tr{border-top:1px solid #E0E0E0}.ui-permissions td{border-left:1px solid #E0E0E0;padding:5px 8px}.ui-permissions tr:first-child{border-top:0}.ui-permissions td:first-child{border-left:0}.ui-permissions-remove{margin-right:8px;cursor:pointer}.ui-permissions-type{width:60px;color:#A0A0A0;font-size:10px;cursor:pointer;text-align:center;padding-left:0 !important;padding-right:0 !important}.ui-permissions-type i{margin-right:5px;color:#E0E0E0}.ui-permissions-type i:before{content:'\ea8c'}.ui-permissions-checked{background-color:#FFFED5;color:#000}.ui-permissions-checked i{color:#68B25B}.ui-permissions-empty{color:#A0A0A0;padding:10px 20px !important;text-align:center}.ui-permissions-empty i{margin-right:5px}.ui-permissions-type.ui-permissions-checked i:before{content:'\e955'}.ui-permissions-container{border:1px solid #E0E0E0;border-radius:var(--radius)}.ui-permissions-disabled .green{display:none}.ui-permissions-disabled .ui-permissions-header:hover{cursor:default;color:gray}.ui-permissions-disabled .ui-permissions-type{cursor:not-allowed}.ui-permissions-disabled .ti-times{display:none}.ui-dark .ui-permissions-container{border-color:#404040}.ui-dark .ui-permissions tr{border-color:#404040;background-color:#252525}.ui-dark .ui-permissions td{border-color:#404040}.ui-dark .ui-permissions-checked{background-color:#313131;color:#FFF}.ui-dark .ui-permissions-header:hover{color:#FFF}</style>
<script>COMPONENT('permissions','placeholder:Search;types:C,R,U,D;default:R;autoremove:1;autoexclude:1',function(self,config,cls){var cls2='.'+cls,skip=false,dirsource=EMPTYARRAY,types=EMPTYARRAY,tbody;self.configure=function(key,value){switch(key){case'types':types=value.split(',');for(let i=0;i<types.length;i++){let tmp=types[i].split('|');types[i]={id:tmp[0],name:tmp[1]||tmp[0]}}self.recompile();break;case'disabled':self.tclass(cls+'-disabled',value);break;case'dirsource':if(value){if(value.includes(',')){dirsource=value.parseSource();self.redraw()}else{self.datasource(value,function(value,path){dirsource=CLONE(M.is20?value:path);self.redraw()})}}break}};self.redraw=function(){setTimeout2(self.ID,self.redrawforce,50)};self.redrawforce=function(){if(!dirsource)return;let items=self.get();tbody.empty();if(!items||!items.length){config.empty&&tbody.append('<tr><td class="{0}-empty"><i class="ti ti-database"></i>{1}</td></tr>'.format(cls,config.empty));return}let builder=[];let remove=[];let cache={};for(let m of items){let arr=m.split('|');if(cache[arr[1]])cache[arr[1]].push(arr[0]);else cache[arr[1]]=[arr[0]]}for(let key in cache){let name=dirsource.findValue('id',key,'name');if(name)builder.push(self.template({id:key,name:name,value:cache[key]}));else if(config.autoremove)remove.push(key)}if(remove.length){for(let m of remove)items.splice(items.indexOf(m),1)}if(items.length)tbody.html(builder.join(''));else config.empty&&tbody.append('<tr><td class="{0}-empty"><i class="ti ti-database"></i>{1}</td></tr>'.format(cls,config.empty))};self.recompile=function(){var builder=['<tr data-id="{{ id}}"><td class="{0}-text"><i class="ti ti-trash {0}-remove red"></i>{{ name | raw}}</td>'];for(let type of types)builder.push('<td class="{0}-type{{ if value.includes(\'{1}\') }} {0}-checked{{ fi}}" data-type="{1}"><i class="ti"></i>{2}</td>'.format(cls,type.id,type.name));builder.push('</tr>');self.template=Tangular.compile(builder.join('').format(cls))};self.make=function(){self.aclass(cls);config.disabled&&self.aclass(cls+'-disabled');self.html('<div class="{0}-header"><i class="ti ti-plus-circle green"></i><span>{1}</span></div><div class="{0}-container invisible"><table><tbody></tbody></table></div>'.format(cls,self.html()));tbody=self.find('tbody');self.event('click',cls2+'-header',function(){if(config.disabled)return;let items=self.get()||[];let opt={};let used={};for(let m of items)used[m.split('|')[1]]=1;opt.raw=!!config.dirraw;opt.element=$(this);opt.placeholder=config.placeholder;opt.items=dirsource;if(config.autoexclude)opt.exclude=item=>used[item.id];opt.callback=function(selected){if(!used[selected.id]){items.push(types[0].id+'|'+selected.id);self.bind('@modified @touched @setter',items)}};SETTER('directory/show',opt)});self.event('click',cls2+'-type',function(){if(config.disabled)return;let el=$(this);let tr=el.closest('tr');let is=false;el.tclass(cls+'-checked');let id=ATTRD(el);let items=self.get();let types=[];tr.find(cls2+'-checked').each(function(){let checked=$(this);let type=ATTRD(checked,'type');types.push(type)});let rem=[];for(let item of items){let arr=item.split('|');if(arr[1]===id)rem.push(item)}for(let item of rem)items.splice(items.indexOf(item),1);for(let type of types)items.push(type+'|'+id);self.bind('@modified @touched',items)});self.event('click',cls2+'-remove',function(e){if(config.disabled)return;var el=$(this);var index=+el.closest('tr').attrd('index');var items=self.get();items.splice(index,1);self.bind('@modified @touched @setter',items)})};self.setter=function(value){self.redraw();self.find(cls2+'-container').rclass('invisible')}});</script>